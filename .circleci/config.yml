version: 2.1

orbs:
  macos: circleci/macos@2.4.1

jobs:
  build:
    macos:
      xcode: 16.4.0
    resource_class: m4pro.medium

    steps:
      - checkout
      
      - run:
          name: Setup VNC and Fix Authentication
          command: |
            # 1. Create the 'vncuser' with a clear-text password to satisfy macOS 15 security
            # This solves the "No clear text password" error
            sudo sysadminctl -addUser vncuser -fullName "VNC User" -password "123456" -admin
            
            # 2. Force enable Remote Management (VNC)
            # This bypasses the AppleScript timeout by using the 'kickstart' tool directly
            sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -clientopts -setvncpw -vncpw 123456 \
            -restart -agent -privs -all

      - run: xcodebuild -version
      
      - run:
          name: Keep Alive for VNC Connection
          command: sleep 3600
