version: 2.1

orbs:
  macos: circleci/macos@2.4.1

jobs:
  build:
    macos:
      xcode: 16.4.0
    # m4pro.medium is the powerful new Apple Silicon runner
    resource_class: m4pro.medium

    steps:
      - checkout
      
      # 1. This orb command prepares the system for VNC
      - macos/enable-vnc:
          password: "MAC_ORB_VNC_PASSWORD"
          
      # 2. FIX: Manually force the password to 123456 for the 'vncuser'
      # This solves the "Authentication Error" you were getting.
      - run:
          name: Fix VNC Password for Login
          command: |
            echo "Setting VNC password for vncuser..."
            sudo /usr/libexec/PlistBuddy -c "Set :vncpw 142323" /Library/Preferences/com.apple.VNCSettings.plist || true
            sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -clientopts -setvncpw -vncpw 142323 \
            -restart -agent -privs -all

      - run: xcodebuild -version
      
      # 3. Keeps the session open so you have time to test
      - run:
          name: Keep Alive (1 Hour)
          command: sleep 3600
