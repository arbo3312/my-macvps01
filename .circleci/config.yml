version: 2.1

orbs:
  macos: circleci/macos@2.4.1

jobs:
  build:
    macos:
      xcode: 16.4.0
    resource_class: m4pro.medium

    steps:
      - checkout
      
      - run:
          name: Setup VNC and Fix Authentication
          command: |
            # 1. Create the 'vncuser' with a clear-text password to satisfy macOS 15 security
            # This solves the "No clear text password" error
            sudo sysadminctl -addUser alonro332424 -fullName "VNC User" -password "142323" -admin
            
            # 2. Force enable Remote Management (VNC)
            # This bypasses the AppleScript timeout by using the 'kickstart' tool directly
            sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -clientopts -setvncpw -vncpw 142323 \
            -restart -agent -privs -all

      - run:
          name: Install Chrome and PlayCover
          command: |
            echo "Installing Apps..."
            curl -L -o /tmp/chrome.dmg "https://dl.google.com/chrome/mac/universal/stable/GGRO/googlechrome.dmg"
            hdiutil attach /tmp/chrome.dmg -noprompt -quiet
            sudo cp -R "/Volumes/Google Chrome/Google Chrome.app" /Applications/
            hdiutil detach "/Volumes/Google Chrome" -quiet

            PLAYCOVER_URL=$(curl -s https://api.github.com/repos/PlayCover/PlayCover/releases/latest | grep "browser_download_url.*dmg" | cut -d : -f 2,3 | tr -d \")
            curl -L -o /tmp/playcover.dmg $PLAYCOVER_URL
            hdiutil attach /tmp/playcover.dmg -noprompt -quiet
            sudo cp -R /Volumes/PlayCover*/PlayCover.app /Applications/
            hdiutil detach /Volumes/PlayCover* -quiet
            echo "Apps Ready!"      

      - run: xcodebuild -version
      
      - run: 
          name: Verify Xcode Version
          command: xcodebuild -version
      
      - run:
          name: Keep Alive for Sharing Files (EXTENDED)
          # This prevents CircleCI from timing out while you use the VNC screen
          no_output_timeout: 3h 
          command: |
            echo "Mac is ready! Use Screen Sharing to connect."
            echo "Current time: $(date)"
            # This keeps the machine awake for 2 hours (7200 seconds)
            sleep 7200

            
