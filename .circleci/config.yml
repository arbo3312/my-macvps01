version: 2.1

orbs:
  macos: circleci/macos@2.4.1

jobs:
  build:
    macos:
      xcode: 16.4.0
    resource_class: m4pro.medium

    steps:
      - checkout
      
      - run:
          name: Setup VNC and Fix Authentication
          command: |
            # 1. Create the 'vncuser' with a clear-text password to satisfy macOS 15 security
            # This solves the "No clear text password" error
            sudo sysadminctl -addUser alonro332424 -fullName "VNC User" -password "142323" -admin
            
            # 2. Force enable Remote Management (VNC)
            # This bypasses the AppleScript timeout by using the 'kickstart' tool directly
            sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -clientopts -setvncpw -vncpw 142323 \
            -restart -agent -privs -all

      - run:
          name: Fix Chrome and PlayCover Installation
          command: |
            echo "--- System Check ---"
            sw_vers  # This prints the exact macOS version for the logs
            
            # 1. Setup installers directory
            mkdir -p /tmp/installers
            cd /tmp/installers

            # 2. Install Chrome
            echo "--- Downloading Chrome ---"
            curl -L -O "https://dl.google.com/chrome/mac/universal/stable/GGRO/googlechrome.dmg"
            
            echo "--- Attaching Chrome DMG ---"
            # We use '-plist' to get machine-readable output and avoid UI prompts
            # We removed '-noprompt' to avoid the "unknown option" error
            MOUNT_INFO=$(hdiutil attach googlechrome.dmg -nobrowse -plist)
            MOUNT_DIR=$(echo "$MOUNT_INFO" | grep -A 1 "mount-point" | grep string | sed 's/<[^>]*>//g' | xargs)
            
            if [ -d "$MOUNT_DIR" ]; then
                echo "Mounted at: $MOUNT_DIR"
                sudo cp -R "$MOUNT_DIR/Google Chrome.app" /Applications/
                hdiutil detach "$MOUNT_DIR"
                echo "Chrome installed."
            else
                echo "Error: Could not mount Chrome. Trying fallback..."
                # Fallback: simple attach
                hdiutil attach googlechrome.dmg -nobrowse
                sudo cp -R "/Volumes/Google Chrome/Google Chrome.app" /Applications/
                hdiutil detach "/Volumes/Google Chrome"
            fi

            # 3. Install PlayCover
            echo "--- Downloading PlayCover ---"
            PLAYCOVER_URL=$(curl -s https://api.github.com/repos/PlayCover/PlayCover/releases/latest | grep "browser_download_url.*dmg" | cut -d : -f 2,3 | tr -d \")
            curl -L -o playcover.dmg "$PLAYCOVER_URL"
            
            echo "--- Attaching PlayCover DMG ---"
            hdiutil attach playcover.dmg -nobrowse
            # Using wildcard since volume names often have version numbers
            sudo cp -R /Volumes/PlayCover*/PlayCover.app /Applications/
            hdiutil detach /Volumes/PlayCover*
            
            echo "--- Cleaning Up ---"
            rm -rf /tmp/installers
            echo "Installation Complete!"
            

      - run: xcodebuild -version
      
      
      - run:
          name: Keep Alive for Sharing Files (EXTENDED)
          # This prevents CircleCI from timing out while you use the VNC screen
          no_output_timeout: 3h 
          command: |
            echo "Mac is ready! Use Screen Sharing to connect."
            echo "Current time: $(date)"
            # This keeps the machine awake for 2 hours (7200 seconds)
            sleep 7200

            
